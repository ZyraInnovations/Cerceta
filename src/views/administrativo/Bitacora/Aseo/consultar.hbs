<div class="max-w-6xl mx-auto p-6 bg-white shadow-md rounded-lg mt-8 space-y-6">
  <h2 class="text-2xl font-semibold mb-4">Consultar Bitácora de Aseo</h2>

  <!-- Formulario de fechas -->
  <form method="POST" action="/bitacora_aseo/consultar" class="flex gap-4 items-end">
    <div>
      <label class="block text-sm font-medium mb-1">Desde</label>
      <input type="date" name="desde" value="{{desde}}" required class="border px-3 py-2 rounded w-full" />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Hasta</label>
      <input type="date" name="hasta" value="{{hasta}}" required class="border px-3 py-2 rounded w-full" />
    </div>
    <div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Consultar
      </button>
    </div>
  </form>

  {{#if registros.length}}
  <table class="min-w-full bg-white border border-gray-300 mt-6 text-sm">
    <thead class="bg-gray-100 text-left">
      <tr>
        <th class="px-3 py-2">Fecha</th>
        <th class="px-3 py-2">Edificio</th>
        <th class="px-3 py-2">Inspeccionado Por</th>
        <th class="px-3 py-2 text-center">Acción</th>
      </tr>
    </thead>
    <tbody>
      {{#each registros}}
      <!-- Fila resumen -->
      <tr class="border-t hover:bg-gray-50">
        <td class="px-3 py-2">{{formatDate this.fecha}}</td>
        <td class="px-3 py-2">{{this.edificio}}</td>
        <td class="px-3 py-2">{{this.inspeccionado_por}}</td>
        <td class="px-3 py-2 text-center">
          <button onclick="toggleDetalle('{{this.id}}')" class="text-blue-600 hover:underline">Mostrar más</button>
        </td>
      </tr>

      <!-- Fila detalle oculta -->
      <tr id="detalle-{{this.id}}" class="hidden bg-gray-50 border-t border-b">
        <td colspan="4" class="p-4">
          <!-- Se agrega un contenedor con id="bitacora-{{this.id}}" para que html2pdf lo capture completamente -->
          <div id="bitacora-{{this.id}}">
            <!-- Encabezado institucional -->
            <div class="border border-gray-300 p-4 mb-4 rounded-lg">
              <div class="flex justify-between items-center border-b pb-2 mb-2">
                <div class="flex items-center">
                  <img src="/imagenes/Recurso 1hdpi.png" alt="CERCETA logo" class="h-16">
                  <div class="ml-4">
                    <h1 class="text-lg font-bold">CERCETA</h1>
                    <p class="text-sm">SOLUCIONES EMPRESARIALES</p>
                  </div>
                </div>
                <div class="text-right text-sm">
                  <p>SST-DO-01</p>
                  <p>REVISION 01</p>
                  <p>{{formatDate this.fecha}}</p>
                  <p>Página 01/01</p>
                </div>
              </div>
              <h2 class="text-center font-bold text-lg mb-2">PLANILLA DE SUPERVISIÓN DE ASEO</h2>
            </div>

            <!-- Datos principales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
              <div><strong>Edificio:</strong> {{this.edificio}}</div>
              <div><strong>Inspeccionado por:</strong> {{this.inspeccionado_por}}</div>
              <div><strong>Cargo:</strong> {{this.cargo}}</div>
            </div>

            <!-- Checklist -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-800 mb-4">
              <div><strong>Paredes:</strong> {{this.paredes}}</div>
              <div><strong>Ventanas:</strong> {{this.ventanas}}</div>
              <div><strong>Pasillos:</strong> {{this.pasillos}}</div>
              <div><strong>Varandas:</strong> {{this.varandas}}</div>
              <div><strong>Salón:</strong> {{this.salon}}</div>
              <div><strong>Shup:</strong> {{this.shup}}</div>
              <div><strong>Terraza:</strong> {{this.terraza}}</div>
              <div><strong>Parqueaderos:</strong> {{this.parqueaderos}}</div>
              <div><strong>Jardinería:</strong> {{this.jardineria}}</div>
              <div><strong>Áreas comunes:</strong> {{this.areas_comunes}}</div>
              <div><strong>Portería:</strong> {{this.porteria}}</div>
            </div>

            <!-- Firmas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <strong>Firma del Supervisor:</strong><br>
                {{#if this.firmaSupervisorData}}
                  <img src="{{this.firmaSupervisorData}}" alt="Firma Supervisor" class="h-16 mt-2" />
                {{else}}<em>Sin firma</em>{{/if}}
              </div>
              <div>
                <strong>Firma del Supervisado:</strong><br>
                {{#if this.firmaSupervisadoData}}
                  <img src="{{this.firmaSupervisadoData}}" alt="Firma Supervisado" class="h-16 mt-2" />
                {{else}}<em>Sin firma</em>{{/if}}
              </div>
            </div>
          </div>
          <!-- Botón para descargar PDF -->
          <div class="text-right">
            <button onclick="descargarPDF('bitacora-{{this.id}}')" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Descargar PDF</button>
          </div>
        </td>
      </tr>
      {{/each}}
    </tbody>
  </table>
  {{else}}
    <p class="text-gray-600 mt-6">No se encontraron registros en ese rango de fechas.</p>
  {{/if}}
</div>

<script src="https://cdn.tailwindcss.com"></script>
<!-- Incluyendo la librería html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  function toggleDetalle(id) {
    const fila = document.getElementById(`detalle-${id}`);
    fila.classList.toggle('hidden');
  }
</script>

<!-- Función mejorarPDF: se asegura de que el contenido esté visible y ajusta opciones para imprimir correctamente -->
<script>
  function descargarPDF(elementId) {
    // Si la fila que contiene el contenido está oculta, se hace visible temporalmente
    const rowId = 'detalle-' + elementId.split('-')[1];
    const detailRow = document.getElementById(rowId);
    let wasHidden = false;
    if (detailRow && detailRow.classList.contains('hidden')) {
      detailRow.classList.remove('hidden');
      wasHidden = true;
    }
    
    // Seleccionamos el contenedor que deseamos convertir a PDF
    const element = document.getElementById(elementId);
    
    // Opciones de configuración para html2pdf: se ajusta la escala, se fuerza que no se realice scroll vertical y se utiliza el formato A4 para un mejor acomodo
    const opt = {
      margin:       0.3,
      filename:     'bitacora_aseo.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, scrollY: 0 },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
      // Una vez generado el PDF se restaura el estado de la fila si era originalmente invisible
      if (wasHidden && detailRow) {
        detailRow.classList.add('hidden');
      }
    });
  }
</script>

<script>
  Handlebars.registerHelper('formatDate', function(fecha) {
    const date = new Date(fecha);
    const opciones = { day: '2-digit', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('es-CO', opciones);
  });
</script>
